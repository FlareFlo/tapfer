<!DOCTYPE html>
<html>
<head>
	<title>{{filename}}</title>
	{% include "components/style.html" %}
	{% include "components/favicon.html" %}
	{% include "components/meta.html" %}
	<style>
		#delete_button {
			background: crimson;
		}
		#copy_link {
			background: green;
			width: 215px;
		}
	</style>
</head>
<body>
<div class="container">
	<div class="form-box">
		<div class="file-info">
			<p><strong>Filename:</strong> {{filename}}</p>
			<p><strong>MIME Type:</strong> {{mimetype}}</p>
			<p id="expiry"><strong>Expires:</strong> {{expiry}}</p>
			<p><strong>Size:</strong> {{filesize}}<span id="upload_percentage"></span></p>
		</div>
		<div style="display: flex; gap: 10px;">
			<form action="{{download_url}}" method="get">
				<button type="submit">Download</button>
			</form>
			<form>
				<button id="copy_link" type="button">Copy direct download link</button>
			</form>
			<button id="delete_button">Delete</button>
		</div>
		<img id="qrcode" src="data:image/png;base64, {{ qr_b64 }}" width="{{qr_size}}px", height="{{qr_size}}px" alt="">
	</div>
</div>

<script>
	const copy_link = document.getElementById('copy_link');
	copy_link.addEventListener('click', async () => {
		try {
			await navigator.clipboard.writeText("{{download_url}}");
			copy_link.innerText = "Copied!";
		} catch (err) {
			console.error('Failed to copy: ', err);
		}
	});

    const delete_button = document.getElementById("delete_button");
    delete_button.addEventListener('click', async () => {
        await fetch("{{delete_url}}", {method: 'DELETE'}).then(res => {
            console.log(res);
            if (res.ok && res.redirected) {
                window.location.href = res.url;
			}
		});
	});

	function main() {
		// Do not parse, as the server will set the expiry string properly
		const realtime = {{ unix_expiry}};
		if (realtime == 0) {
			return;
		}
		const date = new Date(realtime * 1000);
		const pad = (n) => n.toString().padStart(2, '0');

		const hours = pad(date.getHours());
		const minutes = pad(date.getMinutes());
		const day = pad(date.getDate());
		const month = pad(date.getMonth() + 1); // Months are zero-based
		const year = date.getFullYear();

		const formatted = `${hours}:${minutes} ${day}-${month}-${year}`;

		document.getElementById('expiry').innerHTML = `<strong>Expires:</strong> ${formatted}`;
	}
	main()

	const ws = new WebSocket("{{ws_url}}");

	ws.addEventListener("error", (e) => {
		console.error("Failed to openWS:", e);
	});

	ws.addEventListener("open", () => {
		console.log("WS opened!");
	});

	let upload_percentage = document.getElementById("upload_percentage");
	ws.addEventListener("message", (e) => {
		const payload = JSON.parse(e.data);
		switch (payload.event.key) {
			case "DeleteAsset":
				window.location.reload();
				break;
			case "UploadProgress":
				const total = payload.event.total;
				const progress = payload.event.progress;
				let percentage = (progress / total) * 100;
				upload_percentage.innerText = ` Uploading(${percentage.toFixed(1)}%)`;
				break;
			case "UploadComplete":
				upload_percentage.innerText = "";
				break;
		}
	});
</script>
</body>
</html>
